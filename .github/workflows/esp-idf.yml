name: "ESP-IDF Build and Release CI/CD (Docker v5.4)"

on:
  push:
    tags:
      - 'v*'

jobs:
  build-and-release:
    name: Build (ESP-IDF v5.4, Docker)
    runs-on: ubuntu-latest
    # Run the job inside an ESP-IDF Docker image (change image tag if needed)
    container:
      image: espressif/idf:release-v5.4
    env:
      # Ensure the target is ESP32-S3 as the repository expects
      IDF_TARGET: esp32s3
    permissions:
      contents: write   # to create releases

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Show container & IDF info
        run: |
          echo "Container: $(cat /etc/os-release || true)"
          echo "idf.py version: $(idf.py --version || true)"
          echo "IDF_PATH=${IDF_PATH:-/opt/esp/idf}"

      - name: Export ESP-IDF environment
        run: |
          # Export the environment for idf.py (export.sh is provided in the image)
          if [ -n "${IDF_PATH}" ]; then
            . ${IDF_PATH}/export.sh
          else
            . /opt/esp/idf/export.sh
          fi
          idf.py --version

      - name: Build project
        run: |
          . ${IDF_PATH:-/opt/esp/idf}/export.sh
          # Ensure the build target matches the board; sdkconfig.defaults already sets esp32s3
          echo "Using IDF_TARGET=$IDF_TARGET"
          idf.py build

      - name: Check build outputs
        run: |
          echo "=== BUILD DIR CONTENTS ==="
          ls -R build || true

      - name: Zip Release Files
        run: |
          mkdir release_files
          echo "ESP32-S3 WiFi Sniffer Firmware" > release_files/readme.txt
          cp build/bootloader/bootloader.bin release_files/
          cp build/partition_table/partition-table.bin release_files/
          cp build/esp32s3_sniffer.bin release_files/
          cp build/*.elf release_files/
          cp build/flash_project_args release_files/                
          cd release_files
          zip -r ../release-${{ github.ref_name }}-${{ env.IDF_TARGET }}.zip .
          cd .. 

      - name: Create GitHub Release and upload build
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.ref_name }}
          name: ${{ github.ref_name }}
          files: release-${{ github.ref_name }}-${{ env.IDF_TARGET }}.zip  
          body: |
            üöÄ ESP32-S3 WiFi Sniffer Binary Release 
            ------------------------------------------
            * **Version**: ${{ github.ref_name }}
            * **Target**: **${{ env.IDF_TARGET }}**

            üì¶ Included in ZIP: release-${{ github.ref_name }}-${{ env.IDF_TARGET }}.zip
            ```
            - bootloader.bin
            - partition-table.bin
            - esp32s3_sniffer.bin
            - flash_project_args ( for flashing )
            - ELF file(s)   (for debugging)
            ```

            üõ† Flash Guide: (Need ESP-IDF)  
            Flashing parameters are already included in **flash_project_args**
            ```
            esptool.py @flash_project_args
            ```
            
            üìÑ Documentation: 
              [GitHub Pages](https://jeonghunlee.github.io/wifisniffer/)
              [ReadTheDocs](https://esp32-wifi-sniffer.readthedocs.io/) 

            ‚òëÔ∏è Check it below if you find this project useful! 
          generate_release_notes: true          
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}                  


